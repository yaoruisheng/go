name: Build Official Go x86_64 with Custom Patch

on:
  workflow_dispatch:
    inputs:
      go_ref:
        description: '官方 Go 版本 (如 master, go1.24.0)'
        required: true
        default: 'master'
      version_name:
        description: '发布版本标识'
        required: true
        default: 'go-x86_64-custom'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1.下载你自己的仓库（包含 patches 目录）
      - name: Checkout Custom Patches Repo
        uses: actions/checkout@v4
        with:
          path: 'my-repo' # 存放在 my-repo 子目录

      # 2.下载官方 Go 源码
      - name: Checkout Official Go
        uses: actions/checkout@v4
        with:
          repository: 'golang/go'
          ref: ${{ github.event.inputs.go_ref }}
          path: 'go-src' # 存放在 go-src 子目录
          fetch-depth: 1

      # 3.应用补丁 (关键：跨目录引用补丁文件)
      - name: Apply Kernel 4.4.35 Patch
        run: |
          # 进入 Go 源码目录应用来自补丁仓库的 patch 文件
          cd go-src
          patch -p1 < ../my-repo/patches/kernel_4.4.35_compat.patch
          echo "补丁注入成功！"

      # 4.准备 Bootstrap 环境
      - name: Setup Bootstrap Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      # 5.编译 Go 工具链
      - name: Build Go for x86_64
        shell: bash
        run: |
          export GOROOT_BOOTSTRAP=$GOROOT
          export GOOS=linux
          export GOARCH=amd64
          export CGO_ENABLED=0 
          
          # 必须在刚才 checkout 出来的 go-src 目录内编译
          cd go-src/src
          ./make.bash

      # 6.打包并发布
      - name: Package and Release
        shell: bash
        run: |
          cd go-src
          rm -rf pkg/obj pkg/bootstrap
          TAR_FILE="${{ github.event.inputs.version_name }}.tar.gz"
          
          tar --exclude='.git' -czvf "../$TAR_FILE" .
          
          cd ..
          gh release create "${{ github.event.inputs.version_name }}-${{ github.run_number }}" \
            "$TAR_FILE" \
            --title "Go SDK (x86_64) Kernel 4.4 Compat" \
            --notes "基于官方 Go ${{ github.event.inputs.go_ref }} 构建。补丁目标：内核 4.4.35。禁用了 clone3, faccessat2, fchmodat2 和 PidFD。"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
